<!DOCTYPE html>
<html lang="en">
      <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title></title>
            <link href="./index.css" rel="stylesheet">
            <!-- <script src="./scripts.js" defer></script> -->
            <script src="https://unpkg.com/htmx.org@1.9.10"></script>
      </head>
      <body>
            <form
                  class="upload-form"
                  hx-post="/upload"
                  hx-encoding="multipart/form-data"
                  hx-target=".success"
                  hx-swap="innerHTML"
                  hx-on:htmx:after-swap="success();reset();"
                  hx-on:failed_open="alert('Error al intentar abrir archivo/s')"
                  hx-on:failed_read="alert('Error al intentar leer archivo/s')"
                  hx-on:failed_create="alert('Error al crear directorio en servidor')"
                  hx-on:failed_copy="alert('Error al cargar imagen en servidor')"
            >
                  <span id="titulo">Subi tus fotos</span>
                  <div class="upload-container">
                        <input
                              id="upload-input"
                              class="upload-input"
                              type="file"
                              name="files"
                              accept=".jpg, .png, .jpeg, .heic, .svg"
                              multiple
                              onchange="verifyLimits(this);"
                        >
                        </input>
                        <label for="upload-input" class="select-button">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                              Seleccionar
                        </label>
                        <div class="selecciones oculto" id="selecciones">
                              <!-- AquÃ­ se insertan dinamicamente los archivos subidos por el usuario -->
                        </div>
                        <footer id="acciones" class="oculto" >
                              <button type="button" onclick="cancel()">Cancelar</button>
                              <button type="submit" id="subir">Subir</button>
                        </footer>
                  </div>
                  <div class="success oculto">
                        <!-- Aqui se inserta el mensaje de exito por parte del servidor -->
                  </div>
            </form>
      </body>
      <script>
            function verifyLimits(input) {
                  const decenasPorMB = 10; // limite de 10 MB por archivo
                  const limite = ((1024) ** 2) * decenasPorMB;
                  const archivos = input.files;
                  for (const archivo of archivos) {
                        if (archivo.size > limite) {
                              alert(`El archivo ("${archivo.name}") excede el peso permitido de 10 MB`);
                              input.value = "";
                              return
                        }
                  }
                  for(const archivo of archivos){
                        selecciones.insertAdjacentHTML('beforeend', `
                              <div class="seleccion slide-in">
                                    <span>${archivo.name}</span>
                                    <svg class="boton-borrado" onclick="undoSelection(this)" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m336-280 144-144 144 144 56-56-144-144 144-144-56-56-144 144-144-144-56 56 144 144-144 144 56 56ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
                              </div>`)
                  }
                  document.getElementById('selecciones').classList.remove('oculto');
                  document.getElementById('acciones').classList.remove('oculto');
            }

            function cancel() {
                  document.getElementById('upload-input').value = "";
                  document.getElementById('selecciones').classList.add('oculto');
                  document.getElementById('selecciones').innerHTML = "";
                  document.getElementById('acciones').classList.add('oculto');
            }
            function undoSelection(seleccionado){
                  const seleccion = seleccionado.closest('.seleccion');
                  seleccion.classList.remove('slide-in');
                  seleccion.classList.add('slide-out');
                  setTimeout(() => {
                        seleccion.remove();
                        if (!document.querySelector('.seleccion')){
                              cancel();
                        }
                  }, 300)
            }
            function success() {
                  const container = document.querySelector('.upload-container');
                  container.classList.add('slide-out');
                  setTimeout(() => {
                        container.classList.add('oculto'); 
                        cancel();
                        document.querySelector('.success').classList.remove('oculto');
                        document.querySelector('.success').classList.add('slide-in');
                  }, 300);
            }

            function reset() {
                  setTimeout(() => {
                        const alerta = document.querySelector('.success');
                        const container = document.querySelector('.upload-container');

                        alerta.classList.remove('slide-in');
                        alerta.classList.add('slide-out');
                        setTimeout(() => { // devuelve el contenedor a su estado inicial
                              alerta.classList.add('oculto'); 
                              alerta.innerHTML="";
                              alerta.classList.remove('slide-out');
                              container.classList.remove('oculto', 'slide-out');
                              container.classList.add('slide-in');
                        }, 300);
                  }, 1500);
            }
      </script>
</html>
